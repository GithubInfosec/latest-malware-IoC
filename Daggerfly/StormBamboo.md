# StormBamboo Compromises ISP to Abuse Insecure Software Update Mechanisms

## Table of Contents
- [Introduction](#introduction)
- [Key Takeaways](#key-takeaways)
- [Overview](#overview)
- [DNS Poisoning: Now with Abuse of Insecure Automatic Update Mechanisms](#dns-poisoning-now-with-abuse-of-insecure-automatic-update-mechanisms)
- [Follow-on Activity](#follow-on-activity)
- [Conclusion](#conclusion)
- [Source](#source)

## Introduction
**Report Reference:** [SBR01]  
**Summarized by:** [InfoSec]  
**Analysis Date:** [2024/8/05]  
**Report Date:** [2024/8/02]

<p align="center">
    <img src=".img/StormBamboo.png" alt="StormBamboo" />
</p>

---

## Key Takeaways
- StormBamboo successfully compromised an internet service provider (ISP) in order to poison DNS responses for target organizations.
- Insecure software update mechanisms were targeted to surreptitiously install malware on victim machines running macOS and Windows.
- Malware deployed by StormBamboo includes new variants of the MACMA malware.
- Analysis of the newest versions of MACMA shows converged development of the MACMA and GIMMICK malware families.
- Post-exploitation activity included deployment of the malicious browser extension RELOADEXT to exfiltrate victim mail data.

---

## Overview
During one incident investigated by Volexity, it was discovered that StormBamboo poisoned DNS requests to deploy malware via an HTTP automatic update mechanism and poison responses for legitimate hostnames that were used as second-stage, command-and-control (C2) servers.

The DNS records were poisoned to resolve to an attacker-controlled server in Hong Kong at IP address 103.96.130[.]107. Initially, Volexity suspected the initial victim organization’s firewall may have been compromised. However, further investigation revealed the DNS poisoning was not performed within the target infrastructure, but further upstream at the ISP level. Volexity notified and worked with the ISP, who investigated various key devices providing traffic-routing services on their network. As the ISP rebooted and took various components of the network offline, the DNS poisoning immediately stopped. During this time, it was not possible to pinpoint a specific device that was compromised, but various components of the infrastructure were updated or left offline and the activity ceased.

This is not the first case where Volexity has encountered an attacker utilizing DNS poisoning to facilitate initial access to a target network. In the May 2023 Cyber Session, Volexity presented details of a malware family it calls CATCHDNS, DNS poisoning malware used by DriftingBamboo that was deployed to a network appliance (in that instance, a Sophos XG Firewall). Volexity cannot confirm what mechanism was used by StormBamboo on the ISP’s routers to modify DNS responses; however, CATCHDNS would be a well-designed tool to achieve this goal in an ISP environment.

---

## DNS Poisoning: Now with Abuse of Insecure Automatic Update Mechanisms!
In the previously analyzed case where CATCHDNS was used to modify DNS responses, the end goal of the attacks was to modify the content of pages users browsed. This resulted in a popup JavaScript alert on the page asking the user to “update their browser,” which would download a malicious file from the attacker’s server. In this most recent case, the attacker’s method of delivering malware was more sophisticated, abusing insecure automatic update mechanisms present in software in the victim’s environment, thus requiring no user interaction.

The logic behind the abuse of automatic updates is the same for all the applications: the legitimate application performs an HTTP request to retrieve a text-based file (the format varies) containing the latest application version and a link to the installer. Since the attacker has control of the DNS responses for any given DNS name, they abuse this design, redirecting the HTTP request to a C2 server they control hosting a forged text file and a malicious installer. The AiTM workflow is shown below.

<p align="center">
    <img src=".img/workflow.png" alt="AiTM workflow" />
</p>

---

## Follow-on Activity
In one case, following successful compromise of a victim’s macOS device, Volexity observed StormBamboo deploying a Google Chrome extension to the victim’s device. Volexity tracks this malicious extension under the name RELOADEXT. The extension was installed using a custom binary (`ee28b3137d65d74c0234eea35fa536af`) developed by the attacker. The installer supports the following parameters:

| Parameter | Description                                |
|-----------|--------------------------------------------|
| `-p / --plugin` | Path of the plugins (must be a ZIP archive) |
| `-f / --force`  | Kill Chrome and install the plugin           |

The browser extension is deployed by modifying the Secure Preferences file to include the new extension. The installer also correctly fixes the protections.macs and protections.super_mac values in the newly modified SecurePreferences. These values are designed to prevent tampering with a user’s browser settings, but they can be forged. If they do not contain the expected values, Chrome will overwrite the SecurePreferences file.

The plugin passed to this tool is stored in the following location:

```plaintext
$HOME/Library/Application Support/Google/Chrome/Default/Default/CustomPlug1n/Reload/
```

---

## Conclusion
StormBamboo is a highly skilled and aggressive threat actor who compromises third parties (in this case, an ISP) to breach intended targets. The variety of malware employed in various campaigns by this threat actor indicates significant effort is invested, with actively supported payloads for not only macOS and Windows, but also network appliances.

The incident described in this blog post confirms the supposition made by ESET concerning the infection vector for the POCOSTICK malware. The attacker can intercept DNS requests and poison them with malicious IP addresses, and then use this technique to abuse automatic update mechanisms that use HTTP rather than HTTPS. This method is similar to the attack vector Volexity previously observed being used by DriftingBamboo following the 0-day exploitation of Sophos Firewalls.

## Source
[StormBamboo Compromises ISP to Abuse Insecure Software Update Mechanisms](https://www.volexity.com/blog/2024/08/02/stormbamboo-compromises-isp-to-abuse-insecure-software-update-mechanisms/)
