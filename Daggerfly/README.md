# Daggerfly: Espionage Group Makes Major Update to Toolset

## **Table of Contents:**

1. [Introduction](#introduction)
2. [Macma Update](#macma-update)
3. [Attribution to Daggerfly](#attribution-to-daggerfly)
3. [New Backdoor](#new-backdoor)
4. [Heavily Resourced](#heavily-resourced)
5. [Conclusion](#conclusion)
6. [Source](#source)

---

## Introduction

- **Report Reference:** [DGGRR01] 
- **Summarized by:** [InfoSec]  
- **Analysis Date:** [2024/7/26]  
- **Report Date:** [2024/7/23]

APT group appears to be using a shared framework to create Windows, Linux, macOS, and Android threats. The Daggerfly (aka Evasive Panda, Bronze Highland) espionage group has extensively updated its toolset, introducing several new versions of its malware, most likely in response to exposure of older variants. The new tooling was deployed in a number of recent attacks against organizations in Taiwan and a U.S. NGO based in China, which indicates the group also engages in internal espionage. In the attack on this organization, the attackers exploited a vulnerability in an Apache HTTP server to deliver their MgBot malware.

---

## Macma Update:

Macma is a macOS backdoor that was first documented by Google in 2021 but appears to have been used since at least 2019. At the time of discovery, it was being distributed in watering hole attacks involving compromised websites in Hong Kong. The watering holes contained exploits for iOS and macOS devices. Users of macOS devices were targeted with a privilege escalation vulnerability (CVE-2021-30869) which allowed the attackers to install Macma on vulnerable systems.
Macma is a modular backdoor. Functionality includes:
- Device fingerprinting
- Executing commands
- Screen capture
- Keylogging
- Audio capture
- Uploading and downloading files

Recent variants of Macma found by Symantec exhibit evidence of ongoing development. The main difference lies in strings that appear to function as configuration data:
- Updated modules in its appended data
- Updated file directory paths and filenames (and related string quotes when constructing command-lines for processes to start)
- Additional debug logging

Its main module (SHA256: fce66c26deff6a5b7320842bc5fa8fe12db991efe6e3edc9c63ffaa3cc5b8ced) exhibited evidence of more extensive modification. This included:
- New logic to collect a file’s system listing, with the new code based on Tree, a publicly available Linux/Unix utility. 
- Modified code in the AudioRecorderHelper feature
- Additional parametrisation
- Additional debug logging
- Addition of a new file - param2.ini – that is related to settings around a feature named "autoScreenCaptureInfo”.

<p align="center">
    <img src=".img/new_variant_Macma.png" alt="Configuration strings from the main module of a Macma variant documented in 2021 by Objective-See (top) and strings from the main module of two new Macma variants found by Symantec (middle and bottom)" />
</p>

<p align="center">
    Configuration strings from the main module of a Macma variant documented in 2021 by Objective-See (top) and strings from the main module of two new Macma variants found by Symantec (middle and bottom)
</p>

---

## Attribution to Daggerfly

Although Macma was widely believed to have been linked to advanced persistent threat (APT) activity, it has hitherto not been linked to a particular group. However, Symantec has found evidence to suggest that it is part of the Daggerfly toolkit. Two variants of the Macma backdoor connected to a command-and-control (C&C) server (103.243.212[.]98) that was also used by an MgBot dropper.

In addition to this shared infrastructure, Macma and other known Daggerfly malware including Mgbot all contain code from a single, shared library or framework. Elements of this library have been used to build Windows, macOS, Linux, and Android threats. Functionality provided by this library includes:

- Threading and synchronization primitives
- Event notifications and timers
- Data marshaling
- Platform-independent abstractions (e.g. time)

---

## New Backdoor

A new addition to Daggerfly’s toolkit is a Windows backdoor (Trojan.Suzafk), which was first documented by ESET in March 2024 as Nightdoor (aka NetMM) when it was observed being used alongside Mgbot. Suzafk was developed using the same shared library used in Mgbot, Macma, and a number of other Daggerfly tools. 
Suzafk is a multi-staged backdoor capable of using TCP or OneDrive for C&C. The malware contained the following configuration, indicating the functionality to connect to OneDrive is in development or present in other variants of the malware:

```plaintext
ReadMe=ConnONEDRIVE;Version=256;Tag=15ad490f332f3d9a;DownloadUrl=http://103.96.131.150:19876/30_1410402971.exe;token={"refresh_token":"REDACTED","client_id":"4aa6708f-f3c8-4511-8118-5a7208be6a44","client_secret":"REDACTED"};DownloaderSavePath=C:\Programdata\Office\;HttpServerFolder=C:\Program Files\Common Files\Cloudata\;
```

Another configuration to use a TCP connection for C&C purposes is also present in the backdoor:

```plaintext
ReadMe=ConnTCP;Version=256;Tag=15ad490f332f3d9a;DownloadUrl=http://103.96.131.150:19876/30_1292836936.exe;IP=103.96.131.150;Port=40020;DownloaderSavePath=C:\\Programdata\\Office\\;HttpServerFolder=C:\\Program Files\\Common Files\\Cloudata\\;
```

The loader (SHA256: 5687b32cdd5c4d1b3e928ee0792f6ec43817883721f9b86ec8066c5ec2791595) drops two files: Engine.dll and MeitUD.exe. MeituUD.exe is a legitimate application named DAEMON Tools Lite Helper. Engine.dll is a loader DLL that sets persistence via scheduled tasks and loads the final payload in memory.

The backdoor has embedded code from the al-khaser project, a public code repository aimed to detect virtual machines, sandboxes, and malware analysis environments. It also creates the folders C:\ProgramData\Office\EFir and C:\ProgramData\Office\Temps and stores additional network configuration data under the C:\ProgramData\Office\sysmgr file XOR encrypted with the key 0x7A.

---

## Heavily Resourced

New findings provide a clearer picture of the capabilities and resources behind Daggerfly. The group can create versions of its tools targeting most major operating system platforms. In addition to the tools documented here, Symantec has seen evidence of the ability to Trojanize Android APKs, SMS interception tools, DNS request interception tools, and even malware families targeting Solaris OS. Daggerfly appears to be capable of responding to exposure by quickly updating its toolset to continue its espionage activities with minimal disruption. 

---

## Conclusion:
The Daggerfly (aka Evasive Panda, Bronze Highland) espionage group has extensively updated its toolset, introducing several new versions of its malware, most likely in response to exposure of older variants. The new tooling was deployed in a number of recent attacks against organizations in Taiwan and a U.S. NGO based in China, which indicates the group also engages in internal espionage. In the attack on this organization, the attackers exploited a vulnerability in an Apache HTTP server to deliver their MgBot malware.

Among the new additions to Daggerfly’s arsenal are a new malware family based on the group’s MgBot modular malware framework and a new version of the Macma macOS backdoor. While Macma is a previously documented threat, it had hitherto been of unknown authorship. However, Symantec’s Threat Hunter Team has now found evidence suggesting that it is developed by Daggerfly. 

Active for at least a decade, Daggerfly is primarily known for its development and use of the MgBot framework. In 2023, Symantec reported a Daggerfly intrusion against a telecoms operator in Africa involving previously unseen plugins for MgBot.

---

## Source:

[Symantec Enterprise Blogs - Daggerfly Espionage Group Makes Major Update to Toolset](https://symantec-enterprise-blogs.security.com/threat-intelligence/daggerfly-espionage-updated-toolset)
