# Inside SnipBot: The Latest RomCom Malware Variant

## Table of Contents
1. [Introduction](#introduction)
2. [Malware Background](#malware-background)
3. [Email Infection Vector](#Email-Infection-Vector)
4. [SnipBot Malware](#SnipBot-Malware)
5. [Post-Infection Activity](#Post-Infection-Activity)
6. [Conclusion](#conclusion)
7. [Source](#Source)
---

## Introduction

The RomCom cyber-espionage malware that rampaged through the Ukraine military and its supporters last year has resurfaced with a new variant. It leverages valid code-signing certificates to fly under the radar, allowing attackers to execute commands and download additional malicious files onto a victim's system in a multistage attack.

<p align="center">
    <img src=".img/entry.png" alt="entry." />
</p>

The variant, called SnipBot by researchers at Palo Alto's Unit 42, appears to have been spreading since December, picking up where the last version of RomCom left off, they revealed in analysis published this week. The malware is based on RomCom 3.0., but it also shares techniques already seen in RomCom 4.0, making it version 5.0 of the original RomCom remote access Trojan (RAT) family.

---

## Malware Background

RomCom RAT is a malware family that has evolved over the years to include different features and attack methods. The threat actor using RomCom has been active since at least 2022. They engage in ransomware, extortion and targeted credential gathering, likely to support intelligence-gathering operations. RomCom has made multiple advancements, leading to its newest iteration called SnipBot, which employs new commands and evasion techniques.

The SnipBot variant of RomCom leverages a basic set of features that allows the attacker to run commands on a victim's system and download additional modules. The initial payload is always either an executable downloader masked as a PDF file or an actual PDF file sent to the victim in an email that leads to an executable.

The earliest initial sample of SnipBot we found was a PDF file that shows distorted text that states a font is missing that’s needed to show it correctly. If the victim clicks on the contained link that’s purported to download and install the font package, they will instead download the SnipBot downloader.

SnipBot consists of several stages where the initial downloader is always an executable file and the remaining payloads are either EXEs or DLLs. The downloader is always signed with a legitimate and valid code signing certificate. We don’t know how the threat actors obtain these certificates, but it’s likely they steal them or gain them by fraud. Subsequent modules were not signed.

---

## Email Infection Vector

By reviewing Cortex XDR telemetry data and reverse engineering the initial sample, we were able to recreate the whole infection chain. The initial infection vector in our case was an email that contained a link that redirects twice to the SnipBot downloader.

The chain of URLs from the initial one contained in the email to the final SnipBot downloader file link. The attacker registered the domains `fastshare[.]click` and `docstorage[.]link.` The website `temp[.]sh` is a legitimate file sharing service with a set hosting period of three days.

<p align="center">
    <img src=".img/controller_domains.png" alt="Email Infection Vector1." />
</p>

We discovered another chain of links that was likely used by the same attacker to deliver a similar SnipBot downloader variant. The distinct initial domain and the similar downloader file name imply this was part of a campaign targeting multiple victims.

Another chain of URLs used in another attack. The attacker created the domain publicshare[.]link; it is not a legitimate file sharing service.

<p align="center">
    <img src=".img/controller_domains2.png" alt="Email Infection Vector2." />
</p>

---

## SnipBot Malware

The infection chain of the different SnipBot stages. The initial downloader `Attachment_Medical report.exe` is a 64-bit Windows executable 
`(SHA256: 57e59b156a3ff2a3333075baef684f49c63069d296b3b036ced9ed781fd42312)` disguised as a PDF file. It is signed with a presumably stolen or spoofed certificate from CC Byg og Udlejning ApS, which is a company located in Denmark.

<p align="center">
    <img src=".img/snipbotmalware.png" alt="snipbot." />
</p>

This downloader uses two simple yet effective anti-sandbox tricks. The first one checks for the original file name by comparing the hashed process name against a hard-coded value. The second one checks whether there are at least 100 entries in the `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs` registry key, which is usually the case on a regular user’s system but less likely to be the case in a sandbox system.

<p align="center">
    <img src=".img/sandbox.png" alt="sandbox." />
</p>

The RecentDocs registry key of a typical Windows system with more than 100 values present.

<p align="center">
    <img src=".img/registry.png" alt="registry." />
</p>

The downloader is also obfuscated with a window message-based control-flow obfuscation algorithm. The malware code is split up into multiple unordered blocks that are triggered by custom window messages.

To accomplish this, a window is created that has a callback message that contains these code blocks. The window message queue is used to call each block in its original order.

The first message block is triggered by sending the initial message and then each block sends the next message when it’s done. Additionally, each block can also send nested messages, which makes it even more challenging to follow the execution flow.

<p align="center">
    <img src=".img/anti_emulation.png" alt="antiemulation." />
</p>

Most of the strings, such as the command and control (C2) domain name and all the names of dynamically resolved API functions, are encrypted. The threat actor likely did this to prevent easy static detection, thus making malware analysis more time-consuming.

Upon execution, the downloader contacts the first C2 domain `xeontime[.]com` and tries to get a PDF file and the first payload. We couldn’t recover the original downloaded first payload, but for an unknown reason, the attacker later downloaded the same payload with different configuration data and started it manually. We were able to obtain this file and could continue our analysis.

The threat downloads the PDF to the local user’s temporary folder with a random name before opening it. The first payload is a DLL file `(internally named config-pdf.dll)` that the threat executes in memory. It has an exported function named GetStore that contains its malicious code.

This DLL file’s purpose is to download the next stage COM DLL named keyprov.dll from the second C2 `drvmcprotect[.]com` and inject it into Explorer. For this, it uses COM hijacking to register the file as the thumbnail cache library in the registry hive of the current user.

When restarting `explorer.exe`, the DLL gets loaded into its address space and executed. While this is a reliable method of loading a payload into Explorer, forcing it to terminate can result in a crash, as it did on the victim's machine.

<p align="center">
    <img src=".img/process_hacker.png" alt="processhacker." />
</p>

To download the COM DLL from the C2 server, `config-pdf.dll` sends the command `get_update_manager2`. Additionally, the first payload gets a second encrypted DLL by sending the command get_update_inet2.

This payload `(internally named single.dll)` gets stored in the registry in the key `HKCU\SOFTWARE\AppDataSoft\Software` as a binary value named trem1. At last, in the same registry key, the threat creates another binary value named trem3 that contains the string `UPDE1.` The threat likely uses this value to keep track of the number of updates for the registry payloads.

After `keyprov.dll` gets loaded into Explorer, it tries to imitate a real COM provider. It is able to do so as it’s an ordinary DLL with the needed export functions `DllGetClassObject` and `DllCanUnloadNow.` To do so, the code in `keyprov.dll’s DllGetClassObject` function acts as a forwarder to the same named function in `shdocvw.dll`, which is a legit COM DLL also loaded in `explorer.exe.`

The code in DllMain contains the two key tasks of the DLL. These tasks are to decrypt and execute the encrypted payload in the registry and to create a network listener for incoming commands.

The threat’s first task is to decrypt and execute two DLL payloads from the registry values trem1 and trem2. In our case, only the payload stored in trem1 got downloaded from the C2 server.

The second task is to listen on port 1342 for the following incoming string commands sent over TCP. Table 1 shows the commands implemented in `keyprov.dll` related to the bot’s operation.

The main SnipBot file `single.dll` is a backdoor that gives the attacker multiple options to execute commands or download and run additional payloads. All strings are encrypted, with each having its own decryption key.

The file created a mutex named `SnipMutex`, from which the malware’s name is derived. For the initial C2 contact, the threat sends a string that is made from the following information collected from the victim’s system:

- Computer/domain name
- MAC address
- Windows build number
- Whether the machine is a Windows server

The main module provides the operator with command-line, uploading and downloading capabilities on a victim’s system. It also allows an attacker to download and execute the following additional payloads from the attacker’s server:

- `SnippingTool.dll`
- `FontCache.dll`
- `InfoWind.dll`
- `paper.exe`
- `socks5.exe`
- `ms-proxy.exe`
- `svcnet.exe`
- `plink.exe`

While these file names imply what the payloads might do, we can only speculate about their purposes. We haven’t seen any of these files dropped on a victim’s system during our investigation.

When someone sends a command that the threat does not support, it sends the string command: <CmdNumber> does not exist back to the C2 server.

---

## Post-Infection Activity

With the help of Cortex XDR telemetry data, we recreated post-infection activity from the attacker, which was mostly command-line commands. A timeline from the initial infection to the last seen command is shown below.

The attacker's post-infection behavior on April 4, which occurred over a period of roughly four hours.

<p align="center">
    <img src=".img/post-infection.png" alt="post-infection." />
</p>

With the command-line functionality of SnipBot’s main module single.dll, the attacker first tried to gather information about the company’s internal network, including the domain controller. Afterwards, attackers attempted to exfiltrate a list of different files from the victim’s documents, downloads and OneDrive folders to the server with the IP address `91.92.250[.]104.`

This server sent AD Explorer and WinRAR to the victim’s system for the second discovery phase. Before the exfiltration, the attacker packed the files with WinRAR `(renamed as fsutil.exe)`, while the actual data transfer to the server was achieved with the help of the PuTTY Secure Copy client `(renamed as dsutil.exe).`

---

## Conclusion
With the detection capabilities of our advanced Windows sandbox memory scanning tool, we identified an unusual DLL module as part of a new RomCom version dating back to at least December 2023. This updated RomCom version called SnipBot uses a custom obfuscation technique and new anti-analysis tricks.

The attacker's intentions are difficult to discern given the variety of targeted victims, which include organizations in sectors such as IT services, legal and agriculture. While attackers have occasionally dropped ransomware on systems infected with RomCom in the past, this did not occur in our cases or in any of Sophos' incidents. We suspect this threat actor has shifted its aim away from pure financial gain toward espionage.

---

## Source

[Unit42.paloaltonetworks](https://unit42.paloaltonetworks.com/snipbot-romcom-malware-variant/)

---
