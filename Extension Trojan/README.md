# New Widespread Extension Trojan Malware Campaign

### Table of Contents

1. [Introduction](#introduction)  
2. [Executive Summary](#executive-summary)  
3. [Malware Attack Flow](#malware-attack-flow)  
4. [Chrome Web Store Extensions (Registry Forced Install)](#chrome-web-store-extensions-registry-forced-install)  
5. [Microsoft Edge Extension](#microsoft-edge-extension)  
6. [Conclusion](#conclusion)  
7. [Source](#source)

---

## Introduction

- **Report Reference:** [EXTTR01] 
- **Summarized by:** [InfoSec]  
- **Analysis Date:** [2024/8/10]  
- **Report Date:** [2024/8/6]

<p align="center">
    <img src=".img/Screenshot 2024-08-10 023527.png" alt="By ReasonLabs Research Team" />
</p>

Web browser extensions, once niche, are now a major part of the Internet industry, supported by browsers like Microsoft Edge and Google Chrome. This research highlights a widespread malware campaign identified by ReasonLabs, which installs malicious extensions on over 300,000 users. The malware, active since 2021, comes from fake download sites and remains undetected by most AV engines. Google and Microsoft have been alerted and are addressing the issue.

---

## Executive Summary

Web browser extensions have grown from being just a niche piece of software into a full-on sub-economy of the Internet industry. Extensions are supported on most browsers, including Microsoft Edge and Google Chrome - both offer hundreds of thousands of extensions in the Chrome Web Store and Microsoft Edge Add-ons. With the rise in the popularity of extensions has come a rise in malicious extensions built by bad actors who have pinpointed this relatively new malware attack vector. This research article intends to highlight a specific ongoing threat and the larger issue: malicious web extensions.

The ReasonLabs Research Team has identified a new widespread polymorphic malware campaign that forcefully installs extensions on endpoints. The trojan malware contains different deliverables ranging from simple adware extensions that hijack searches to more sophisticated malicious scripts that deliver local extensions to steal private data and execute various commands. This trojan malware, existing since 2021, originates from imitations of download websites with add-ons to online games and videos. We have witnessed a very wide distribution of the malware and extensions - in total at least 300,000 users across Google Chrome and Microsoft Edge have been affected.

At the time of writing, most AV engines do not detect the installer and the extensions. Countless users across the web are complaining about an extension that they cannot get rid of, even posting complaints on the extension page on the Chrome or Edge store - stating that it is a virus that they cannot get rid of, they don’t know how it appeared, and it keeps returning after attempts to remove it.

We alerted Google and Microsoft as soon as we became aware of the issue and they are taking the appropriate measures.

---

## Malware Attack Flow

Advertisers implemented imitations of download sites like Roblox FPS Unlocker, YouTube, VLC, or KeePass to deliver trojans that install malicious extensions. The executables downloaded from the fake websites do not even attempt to install the program the user wanted. In some newer versions, we’ve witnessed installations that pull the original program from a Google storage link, using API to download it. (For a list of fake sites and their installers, visit the “IOCs” section).

<p align="center">
    <img src=".img/Screenshot 2024-08-10 023703.png" alt="Fake and Original" />
</p>

Once a user downloads the program from the lookalike website, the program registers a scheduled task using a pseudonym that follows the pattern of a PowerShell script file name, like `Updater_PrivacyBlocker_PR1`, `MicrosoftWindowsOptimizerUpdateTask_PR1`, and `NvOptimizerTaskUpdater_V2`. It’s configured to run a PowerShell script with a similar-looking name `-File C:/Windows/System32/NvWinSearchOptimizer.ps1`. The PowerShell script downloads a payload from a remote server and executes it on the machine. It is important to note that the PowerShell script is written to the system32 folder.

The task:

```plaintext
C:\Windows\system32\cmd.exe /d /s /c “SCHTASKS /Create /TN
“NvOptimizerTaskUpdater_V2” /SC HOURLY /TR “powershell -File
C:/Windows/System32/NvWinSearchOptimizer.ps1” /RL HIGHEST /MO 4 /RU System /ST
07:27”
```

The script is very short and invokes a second stage script from the C2 directly to memory:

<p align="center">
    <img src=".img/Screenshot 2024-08-10 023737.png" alt="the C2 directly to memory" />
</p>

The installer is signed by Tommy Tech LTD. Other installers signed by the same signer have been around since 2021. During the executions, a folder is created at `c:\windows\NvOptimizerLog` where the rest of the files are dropped. The folder’s name varies from time to time, based on the campaign.

Most stages of the installation, as well as all related domains, are not detected as malicious.

The important part of the execution begins when the PowerShell script is finally executed. The script has four interesting functions:

1. **Adds registry values to force the installation of extensions from the store** (HKLM:\SOFTWARE\Policies\Google\Chrome\ExtensionInstallForcelist, HKLM:\SOFTWARE\Policies\Microsoft\Edge\ExtensionInstallForcelist):
    - The extension steals search queries and redirects them through the adversary’s search.
    - The extension cannot be disabled by the user, even with Developer Mode ‘ON’.
    - This method results in a message on the browser: “Your browser is managed by your organization”.
    - Newer versions of the script remove browser updates.

2. **Tampers with browser “.lnk” files to load a local extension that it drops** (`$shortcut.Arguments = "$CArgs --load-extension=$CLocalPath"`):
    - The local extension again focuses on stealing search queries, but it can also communicate with the C2. It goes through great efforts to obfuscate and hide its activity. It cannot be seen on the “Extensions” management page, so an unsuspecting user cannot easily detect the extension’s existence.

3. **Communicates with CnC to report on the status and get the next stages to execute**:
    - This function downloads and executes with `invoke-expression`. This script in our case is tampering with Chrome/Edge browser DLL (i.e. `msedge.dll`), and overrides bytes in the file that specifies the browser’s search engine.

At the time of writing, almost no one has recognized the relatively new C2 domain as malicious. This is the domain the PowerShell script contacts to download the second stage of the PowerShell script that then modifies the browser’s assets.

We have also found more variations of the PowerShell script that contact the domain `nvoptimizer[.]com`, which was created one year ago, as opposed to `nvoptimize[.]com`, created six months ago.

---

## Chrome Web Store Extensions (Registry Forced Install)

**Extension id for example:** `nniikbbaboifhfjjkjekiamnfpkdieng`

We first identified the adware Chrome extension called “Custom Search Bar” when we began our research in 2022. The extension was first available in 2021 and by 2022 had amassed more than 60,000 users. Recently, however, that extension no longer appears on the Chrome Web Store and new malicious extensions have surfaced from the same origin. For example, some of the new extensions are called “Micro Search”, which until recently was available for download with over 30,000 users, and “yglSearch”, which is still currently available for download and has over 40,000 users.

<p align="center">
    <img src=".img/chromext.png" alt="Chrome Extension" />
</p>


The domain of “Micro Search” (microsearch[.]me) was the same as the previously removed extension, however it was removed from the Chrome Web Store on April 25th. The distribution method remains the same, along with all of the previous domains. It is impressive how under the radar this malware is given that it has been operating for years without even changing its C2 domains, probably because it hasn’t needed to. By counting the number of users on each extension related to the campaigns, over 200,000 users have been affected by the malware.

---

## Microsoft Edge Extension

We have witnessed force installations of Microsoft Edge extensions, along with Google Chrome extensions. One of the most widespread is an extension with 100,000+ users called “Simple New Tab”. On the Microsoft Edge Add-ons page, the extension is described as “replacing the new tab page with beautiful backgrounds”.


<p align="center">
    <img src=".img/edgext.png" alt="Edge Extension" />
</p>


---

## Conclusion

- **Malware Campaign:** A widespread polymorphic malware campaign installs malicious browser extensions, affecting over 300,000 users.
- **Attack Vector:** The malware originates from imitation download sites and remains undetected by most AV engines.
- **Malicious Behavior:** The extensions hijack search queries, redirect them, and cannot be disabled by users.
- **Technical Details:** The malware utilizes PowerShell scripts to download and execute payloads, tampering with browser DLL files and creating persistent tasks.
- **Response:** Google and Microsoft have been alerted and are addressing the issue.

---

## Source

- [ReasonLabs Research Team](https://reasonlabs.com/research/new-widespread-extension-trojan-malware-campaign)

