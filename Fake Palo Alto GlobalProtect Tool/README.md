# Threat Actors Target the Middle East Using Fake Palo Alto GlobalProtect Tool

Threat actors are targeting users in the Middle East by distributing sophisticated malware disguised as the Palo Alto GlobalProtect tool.

## Table of Contents
1. [Introduction](#introduction)
2. [Key Points](#key-points)
3. [Technical Analysis](#technical-analysis)
    1. [Infection Chain](#infection-chain)
    2. [Malware Commands](#malware-commands)
4. [Conclusion](#conclusion)
5. [Source](#source)

## Introduction

A sophisticated malware sample was discovered, employing a two-stage infection process and seemingly originating from the Middle East, disguised as the Palo Alto GlobalProtect tool. This malware leverages a command-and-control (C&C) infrastructure that pivots to a newly registered URL resembling a VPN portal, enhancing its ability to infiltrate and maintain access to compromised networks. By utilizing the Interactsh project for beaconing, the malware communicates with hostnames to monitor infection progress.

<p align="center">
    <img src=".img/entry.png" alt=" Fake Palo Alto GlobalProtect tool" />
</p>


- **Users in the Middle East are potentially being targeted by threat actors through malware disguised as the Palo Alto GlobalProtect Tool.**

- **The malware uses a two-stage infection routine and advanced C&C infrastructure.**

- **It infects victims via a setup.exe file while using the Interactsh project for beaconing, communicating with specific hostnames to report infection progress and gather victim information.**

- **The malware can execute remote PowerShell commands, download and exfiltrate files, encrypt communications, and bypass sandbox solutions, representing a significant threat to targeted organizations.**

---

## Key Points

- **Target Region**: Middle East.
- **Disguise**: Malware masquerading as the Palo Alto GlobalProtect tool.
- **Capabilities**: Remote command execution, file exfiltration, encrypted communications.
- **Infection Method**: `GlobalProtect64.msi` file leading to further infection steps.
- **Beaconing Tool**: Interactsh project used for beaconing and tracking infection stages.
- **C&C Infrastructure**: Dynamic C&C infrastructure mimicking legitimate VPN portals.

---

## Technical Analysis

### Infection Chain

The exact delivery method of this malware remains unclear, but it is suspected to have been part of a phishing attack that deceives victims into believing they are installing a legitimate GlobalProtect agent. 

<p align="center">
    <img src=".img/infection.chain.png" alt=" Fake Palo Alto GlobalProtect tool" />
</p>

The infection chain begins with a file named setup.exe, which is the initial stage of the attack. This executable deploys GlobalProtect.exe, which is the primary component of the malware, along with the configuration files RTime.conf and ApProcessId.conf. These files are then placed in the directory C:\\Users\(UserName)\AppData\Local\Programs\PaloAlto\.

Once executed, GlobalProtect.exe initiates a beaconing mechanism to notify the threat actor of the successful completion of each phase of the infection process. It communicates with hostnames such as step[1-6]-[dsktoProcessId].tdyfbwxngpmixjiqtjjote3k9qwc31dsx.oast[.]fun to report the routine’s progress, specifically during “step1-6” of the infection chain.

---

### Malware Commands

The malware uses four types of commands, which are explained in the following table:

| Command            | Details                                                                                                                                                                                                                                                       |
|--------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **time to reset**  | Commands the malware to sleep for a specific amount of time.                                                                                                                                                                                                 |
| **pw**             | Execute a PowerShell script and return the result to the server `hxxp[:]//94.131.108.78[:]7118/B/hi/`, after which the threat actor is notified via DNS request if “step6” is successful.                                                                     |
| **pr**             | Processes a command string and performs different actions based on the command type:                                                                                                                                                                          |
|                    | - **wtime**: Reads or writes a wait time to a file.                                                                                                                                                                                                          |
|                    | - **create-process**: Starts a process and returns its output.                                                                                                                                                                                               |
|                    | - **dnld**: Downloads a file from a URL to a local path.                                                                                                                                                                                                     |
|                    | - **upl**: Uploads a file to a remote server.                                                                                                                                                                                                                |
|                    | Encryption is used for secure communication with the remote server. If the command is unrecognized, it returns an "invalid program command" message. The result is sent to the C&C server `hxxp[:]//94.131.108.78[:]7118/B/hi/`.                                                                    |
| **invalid command type** | In case an error occurs in any part of the execution, the malware uses the command function to send the result via the string “invalid command type”.                                                                                                      |

---

## Conclusion

The malware sample we examined, which likely targets entities within the Middle East, reveals a sophisticated use of C&C infrastructure and advanced evasion techniques.

1. **Using dynamic C&C infrastructure**: The malware pivots to a newly registered URL, "sharjahconnect" (likely referring to the UAE emirate Sharjah), designed to resemble a legitimate VPN portal for a company based in the UAE. This tactic is designed to allow the malware’s malicious activities to blend in with expected regional network traffic and enhance its evasion characteristics.

2. **Domain masquerading**: By mimicking a familiar regional service, the attackers exploit trust relationships, increasing the likelihood of successful C&C communications.

3. **Geopolitical targeting**: The domain's regional specificity and the origin of the submission suggest a targeted campaign against Middle Eastern entities, possibly for geopolitical or economic espionage.

4. **Using newly registered domains**: Using fresh domains for C&C activities allows attackers to bypass blacklists and makes attribution more complicated.

---

## Source

[Threat Actors Target the Middle East Using Fake Palo Alto GlobalProtect Tool](https://www.trendmicro.com/en_us/research/24/h/threat-actors-target-middle-east-using-fake-tool.html)
